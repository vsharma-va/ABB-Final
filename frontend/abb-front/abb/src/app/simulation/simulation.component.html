<!-- Loading State -->
<div *ngIf="isLoading" class="loading-container">
  <mat-spinner></mat-spinner>
  <p>Connecting to simulation stream...</p>
</div>

<!-- Error State -->
<div *ngIf="error && !isLoading" class="error-container">
  <p class="error-message">{{ error }}</p>
  <button mat-raised-button color="primary" (click)="startSimulation()">
    Retry
  </button>
</div>

<!-- Main Content: Reverted to *ngIf for cleaner state management -->
<div *ngIf="!isLoading && !error" class="simulation-container">
  <h1>Model Simulation</h1>

  <!-- Simulation Controls -->
  <div class="simulation-controls">
    <button 
      mat-raised-button 
      color="primary"
      (click)="startSimulation()" 
      [disabled]="isSimulating && !simulationComplete"
    >
      {{ simulationComplete ? 'Restart Simulation' : 'Start Simulation' }}
    </button>
    
    <div *ngIf="simulationComplete" class="simulation-status">
      <span class="success-message">
        <mat-icon>check_circle</mat-icon>
        Simulation completed
      </span>
    </div>
  </div>

  <!-- Stats and Charts Row -->
  <div class="stats-charts-row">
    <!-- Statistics Panel -->
    <div class="statistics-panel">
      <h3>Statistics</h3>
      <div class="stat-item">
        <span class="stat-label">Total Predictions:</span>
        <span class="stat-value">{{ totalPredictions }}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Pass Count:</span>
        <span class="stat-value pass">{{ passCount }}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Fail Count:</span>
        <span class="stat-value fail">{{ failCount }}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Avg Confidence:</span>
        <span class="stat-value">{{ averageConfidence | number:'1.0-2' }}%</span>
      </div>
    </div>

    <!-- Line Chart -->
    <!-- <div class="chart-container">
      <h3>Real-Time Quality Predictions</h3>
      <canvas id="lineChart"></canvas>
    </div>


    <div class="chart-container">
      <h3>Prediction Distribution</h3>
      <canvas id="donutChart"></canvas>
    </div> -->
  </div>

  <!-- Live Prediction Table -->
  <div class="prediction-table-container">
    <h3>Live Prediction Stream</h3>
    <div class="table-wrapper">
      <table mat-table [dataSource]="simulationData" class="prediction-table">
        
        <!-- Time Column -->
        <ng-container matColumnDef="time">
          <th mat-header-cell *matHeaderCellDef>Time</th>
          <td mat-cell *matCellDef="let element">
            {{ element.time | date:'shortTime' }}
          </td>
        </ng-container>

        <!-- Sample ID Column -->
        <ng-container matColumnDef="sampleId">
          <th mat-header-cell *matHeaderCellDef>Sample ID</th>
          <td mat-cell *matCellDef="let element">{{ element.sampleId }}</td>
        </ng-container>

        <!-- Prediction Column -->
        <ng-container matColumnDef="prediction">
          <th mat-header-cell *matHeaderCellDef>Prediction</th>
          <td mat-cell *matCellDef="let element" 
              [class.prediction-pass]="element.prediction === 'Pass'"
              [class.prediction-fail]="element.prediction === 'Fail'">
            {{ element.prediction }}
          </td>
        </ng-container>

        <!-- Confidence Column -->
        <ng-container matColumnDef="confidence">
          <th mat-header-cell *matHeaderCellDef>Confidence</th>
          <td mat-cell *matCellDef="let element">
            {{ element.confidence | number:'1.0-2' }}%
          </td>
        </ng-container>

        <!-- Temperature Column -->
        <ng-container matColumnDef="temperature">
          <th mat-header-cell *matHeaderCellDef>Temperature</th>
          <td mat-cell *matCellDef="let element">
            {{ element.temperature !== null ? (element.temperature | number:'1.0-1') + 'Â°C' : 'N/A' }}
          </td>
        </ng-container>

        <!-- Humidity Column -->
        <ng-container matColumnDef="humidity">
          <th mat-header-cell *matHeaderCellDef>Humidity</th>
          <td mat-cell *matCellDef="let element">
            {{ element.humidity !== null ? (element.humidity | number:'1.0-1') + '%' : 'N/A' }}
          </td>
        </ng-container>

        <!-- Pressure Column -->
        <ng-container matColumnDef="pressure">
          <th mat-header-cell *matHeaderCellDef>Pressure</th>
          <td mat-cell *matCellDef="let element">
            {{ element.pressure !== null ? (element.pressure | number:'1.0-1') + 'hPa' : 'N/A' }}
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>
  </div>
</div>
